#!/bin/bash
set -e

echo "=== Extracting Kubernetes Offline Bundle ==="

BUNDLE_FILE="/tmp/k8s-transfer/k8s-offline-bundle.tar.gz"
EXTRACT_DIR="/opt/k8s-offline"

# Check if bundle exists
if [ ! -f "$BUNDLE_FILE" ]; then
    echo "âŒ Error: Bundle file not found: $BUNDLE_FILE"
    exit 1
fi

# Create extraction directory
echo "ğŸ“ Creating extraction directory: $EXTRACT_DIR"
sudo mkdir -p $EXTRACT_DIR
sudo chown {{ k8s_user }}:{{ k8s_group }} $EXTRACT_DIR

# Extract bundle
echo "ğŸ“¦ Extracting bundle..."
if ! tar -xzf "$BUNDLE_FILE" -C "$EXTRACT_DIR" --strip-components=1; then
    echo "âŒ Error: Failed to extract bundle"
    exit 1
fi

# Fix permissions
echo "ğŸ”§ Setting permissions..."
sudo chown -R {{ k8s_user }}:{{ k8s_group }} $EXTRACT_DIR
find $EXTRACT_DIR -type f -name "*.sh" -exec chmod +x {} \;

# Verify extracted content
echo "ğŸ” Verifying extracted content..."

check_directory() {
    local dir=$1
    local desc=$2
    if [ -d "$dir" ] && [ "$(ls -A $dir 2>/dev/null)" ]; then
        local file_count=$(find "$dir" -type f 2>/dev/null | wc -l || echo 0)
        echo "âœ… $desc: $file_count files"
        return 0
    else
        echo "âŒ $desc: MISSING OR EMPTY"
        return 1
    fi
}

check_directory "$EXTRACT_DIR/files/packages" "Packages"
check_directory "$EXTRACT_DIR/files/images" "Docker images"
check_directory "$EXTRACT_DIR/scripts" "Scripts"
check_directory "$EXTRACT_DIR/roles" "Ansible roles"

# Create symlink for easier access
if [ ! -L "/opt/k8s-ansible" ]; then
    sudo ln -sf $EXTRACT_DIR /opt/k8s-ansible
    echo "ğŸ”— Created symlink: /opt/k8s-ansible -> $EXTRACT_DIR"
fi

echo ""
echo "ğŸ‰ Extraction completed successfully!"
echo "ğŸ“ Project location: $EXTRACT_DIR"
echo "ğŸ”— Quick access: /opt/k8s-ansible"
echo ""
echo "Next steps:"
echo "1. cd $EXTRACT_DIR"
echo "2. Update inventory/hosts.yml with your server IPs"
echo "3. Run: ansible-playbook -i inventory/hosts.yml site.yml"