#!/bin/bash
set -e

echo "=== Loading Docker images to local registry ==="

REGISTRY="{{ registry_url }}"
IMAGES_DIR="{{ images_source_dir | default(k8s_home + '/k8s-offline/files/images') }}"

# Check if images directory exists
if [ ! -d "$IMAGES_DIR" ]; then
    echo "❌ Error: Images directory not found: $IMAGES_DIR"
    exit 1
fi

echo "📁 Loading images from: $IMAGES_DIR"

# Load and push each image
for image_tar in "$IMAGES_DIR"/*.tar; do
    if [ -f "$image_tar" ]; then
        image_name=$(basename "$image_tar" .tar)
        echo "📦 Loading: $image_name"

        # Load image from tar
        docker load -i "$image_tar"

        # Get the actual image name after loading
        loaded_image=$(docker images --format "{{ '{{.Repository}}:{{.Tag}}' }}" | grep "$image_name" | head -1)

        if [ -n "$loaded_image" ]; then
            echo "🚀 Pushing: $loaded_image to $REGISTRY"

            # Tag for local registry
            docker tag "$loaded_image" "$REGISTRY/$loaded_image"

            # Push to registry
            docker push "$REGISTRY/$loaded_image"

            # Remove temporary tag
            docker rmi "$REGISTRY/$loaded_image"

            echo "✅ Success: $loaded_image"
        else
            echo "⚠️  Warning: Could not find loaded image for $image_name"
        fi
    fi
done

echo ""
echo "🎉 All images loaded successfully!"
echo "📋 Checking registry catalog..."

# Display catalog
curl -s -X GET "http://$REGISTRY/v2/_catalog" | python3 -m json.tool 2>/dev/null || curl -s -X GET "http://$REGISTRY/v2/_catalog"